# Render + Supabase Deployment Configuration
# render.yaml (place in project root)

services:
  - type: web
    name: cohort-web-app
    env: python
    region: oregon
    plan: free

    buildCommand: |
      echo "Installing backend dependencies"
      pip install --upgrade pip
      pip install -r backend/requirements.txt

      echo "Building frontend"
      npm install
      npm run build

      echo "Copy frontend build into Django static folder"
      mkdir -p backend/static/frontend
      cp -r dist/* backend/static/frontend/

      echo "Collect Django static files"
      cd backend
      python manage.py collectstatic --noinput
      cd ..

    startCommand: |
      cd backend && gunicorn config.wsgi:application \
        --bind 0.0.0.0:$PORT \
        --workers 2 \
        --timeout 120 \
        --access-logfile - \
        --error-logfile -

    healthCheckPath: /api/health/
    
    # Auto-deploy settings
    autoDeploy: true
    branch: main_deploy  # Deploy combined frontend+backend from this branch
    
    # Environment variables (add these in Render dashboard)
    envVars:
      - key: PYTHON_VERSION
        value: 3.13.0
      
      - key: NODE_VERSION
        value: 20.11.0
      
      # Django settings
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      
      - key: SECRET_KEY
        generateValue: true  # Render will generate a secure random key
      
      - key: DEBUG
        value: False
      
      - key: ALLOWED_HOSTS
        value: cohort-app-g06z.onrender.com,localhost,127.0.0.1
      
      # Supabase Database Connection
      - key: DATABASE_URL
        value: postgresql://postgres.yfoopcuwdyotlukbkoej:Cohort_db%40123@aws-1-ap-northeast-1.pooler.supabase.com:6543/postgres
      
      # Supabase Authentication & API
      - key: SUPABASE_URL
        sync: false  # Add from Supabase: Settings > API > Project URL
      
      - key: SUPABASE_ANON_KEY
        sync: false  # Add from Supabase: Settings > API > anon public key
      
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false  # Add from Supabase: Settings > API > service_role secret
      
      # JWT Settings
      - key: JWT_SECRET_KEY
        generateValue: true
      
      - key: JWT_ACCESS_TOKEN_LIFETIME_MINUTES
        value: 60
      
      - key: JWT_REFRESH_TOKEN_LIFETIME_DAYS
        value: 7
      
      - key: JWT_ALGORITHM
        value: HS256
      
      # CORS Settings (update after deployment)
      - key: CORS_ALLOWED_ORIGINS
        value: https://cohort-web-app.onrender.com
      
      # Static/Media files
      - key: STATIC_URL
        value: /static/
      
      - key: MEDIA_URL
        value: /media/
      
      # Email settings (optional - configure if using email)
      - key: EMAIL_BACKEND
        value: django.core.mail.backends.smtp.EmailBackend
      
      - key: EMAIL_HOST
        sync: false
      
      - key: EMAIL_PORT
        value: 587
      
      - key: EMAIL_USE_TLS
        value: True
      
      - key: EMAIL_HOST_USER
        sync: false
      
      - key: EMAIL_HOST_PASSWORD
        sync: false

# Database is provided by Supabase (external)
# No need to define database service here
