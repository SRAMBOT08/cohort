services:
  # Full-Stack Service (Django Backend + React Frontend)
  - type: web
    name: cohort-app
    runtime: python
    region: oregon
    plan: free
    buildCommand: |
      # Install frontend dependencies and build React app
      npm install
      npm run build
      # Install backend dependencies
      cd backend
      pip install -r requirements.txt
      # Collect Django static files first
      python manage.py collectstatic --no-input
      # Copy React build files to staticfiles (overwrite)
      cp -rf ../dist/* staticfiles/
      # Verify index.html exists
      ls -la staticfiles/index.html
      # Run migrations
      python manage.py migrate
      # Create initial users
      python create_role_users.py || echo "Users may already exist"
    startCommand: cd backend && daphne -b 0.0.0.0 -p $PORT config.asgi:application
    healthCheckPath: /
    envVars:
      - key: PYTHON_VERSION
        value: 3.12.0
      - key: NODE_VERSION  
        value: 20.11.0
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: False
      - key: ALLOWED_HOSTS
        value: .onrender.com
      - key: CORS_ALLOWED_ORIGINS
        value: https://cohort-app.onrender.com
      - key: DATABASE_URL
        sync: false  # Set manually: postgresql://postgres.[ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: REDIS_URL
        value: redis://localhost:6379
      - key: VITE_API_URL
        value: /api

# Database: Supabase PostgreSQL (configured via DATABASE_URL)
# Before deploying, set DATABASE_URL in Render dashboard:
# Format: postgresql://postgres.[ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres

# Single service deployment: Both frontend and backend run on same URL
# Frontend: https://cohort-app.onrender.com/
# Backend API: https://cohort-app.onrender.com/api/
# Admin: https://cohort-app.onrender.com/admin/
