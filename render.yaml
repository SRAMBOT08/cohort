# Render Backend-Only Deployment Configuration
# Frontend: Cloudflare Pages (static)
# Backend: Render (Django API)
# Database: Supabase (PostgreSQL)

services:
  - type: web
    name: cohort-backend-api
    env: python
    region: oregon
    plan: free
    
    # Source code
    buildCommand: |
      echo "Installing Python dependencies..."
      pip install --upgrade pip
      pip install -r backend/requirements.txt
      
      echo "Collecting Django static files..."
      cd backend
      python manage.py collectstatic --noinput
      cd ..
    
    startCommand: |
      cd backend && \
      python manage.py migrate && \
      python manage.py sync_supabase_mappings && \
      gunicorn config.wsgi:application \
        --bind 0.0.0.0:$PORT \
        --workers 2 \
        --timeout 120 \
        --access-logfile - \
        --error-logfile -
    
    healthCheckPath: /api/health/
    
    # Auto-deploy settings
    autoDeploy: true
    branch: cloud_deploy
    
    # Environment variables
    envVars:
      # Python Configuration
      - key: PYTHON_VERSION
        value: 3.13.0
      
      # Django Settings
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      
      - key: SECRET_KEY
        generateValue: true
      
      - key: DEBUG
        value: False
      
      # IMPORTANT: Add your Cloudflare Pages URL here after first deployment
      - key: ALLOWED_HOSTS
        value: cohort-backend-api.onrender.com,localhost,127.0.0.1
      
      # Supabase Database Connection
      - key: DATABASE_URL
        value: postgresql://postgres.yfoopcuwdyotlukbkoej:Cohort_db%40123@aws-1-ap-northeast-1.pooler.supabase.com:6543/postgres
      
      # Supabase Authentication & API
      - key: SUPABASE_URL
        value: https://yfoopcuwdyotlukbkoej.supabase.co
      
      - key: SUPABASE_ANON_KEY
        value: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlmb29wY3V3ZHlvdGx1a2Jrb2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MDA4NDEsImV4cCI6MjA4NTM3Njg0MX0.YK5uw24Grhc2TPYnF98i0eORgZHNHLJMdd5akenvKRs
      
      - key: SUPABASE_SERVICE_ROLE_KEY
        value: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlmb29wY3V3ZHlvdGx1a2Jrb2VqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTgwMDg0MSwiZXhwIjoyMDg1Mzc2ODQxfQ.57FMzdhavCWYdp2-yjiWrtt7ZrEHq3Aq6YyChihx1sc
      
      - key: SUPABASE_JWT_SECRET
        value: zy/392pVFfUBs/+wzZmA9Y8/B+R9tCjSLHZMaubjIiv6NUzu4yMtQtbmNYCFuz7ZVQZHlpAHZ4DHzJqb/Frjcg==
      
      # JWT Settings
      - key: JWT_SECRET_KEY
        generateValue: true
      
      - key: JWT_ACCESS_TOKEN_LIFETIME_MINUTES
        value: 60
      
      - key: JWT_REFRESH_TOKEN_LIFETIME_DAYS
        value: 7
      
      - key: JWT_ALGORITHM
        value: HS256
      
      # CORS Settings - Frontend on Cloudflare Pages
      - key: CORS_ALLOWED_ORIGINS
        value: https://cohort-frontend.pages.dev,http://localhost:5173

      # Static/Media files
      - key: STATIC_URL
        value: /static/
      
      - key: MEDIA_URL
        value: /media/

      # Email Configuration (Gmail - Recommended)
      # See EMAIL_SETUP_GUIDE.md for complete setup instructions
      - key: EMAIL_BACKEND
        value: django.core.mail.backends.smtp.EmailBackend
      
      # Gmail SMTP server
      - key: EMAIL_HOST
        value: smtp.gmail.com
      
      - key: EMAIL_PORT
        value: 587
      
      - key: EMAIL_USE_TLS
        value: True
      
      # IMPORTANT: Replace with your Gmail address in Render Dashboard
      - key: EMAIL_HOST_USER
        value: your-email@gmail.com
      
      # IMPORTANT: Set this in Render Dashboard with Gmail App Password
      # Generate at: https://myaccount.google.com/apppasswords
      - key: EMAIL_HOST_PASSWORD
        sync: false
      
      # Default "From" address for sent emails
      - key: DEFAULT_FROM_EMAIL
        value: your-email@gmail.com


# Database is provided by Supabase (external)
# Frontend is provided by Cloudflare Pages (external)
